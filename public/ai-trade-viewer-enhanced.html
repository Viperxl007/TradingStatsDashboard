<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trade Viewer Portal</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 50%, #4a5568 100%); 
            min-height: 100vh; 
            color: #f7fafc; 
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 16px; 
            padding: 32px; 
            margin-bottom: 24px; 
            backdrop-filter: blur(20px); 
            border: 1px solid rgba(255, 255, 255, 0.12); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .title { font-size: 2.5rem; font-weight: bold; margin-bottom: 8px; color: #ffffff; }
        .subtitle { opacity: 0.9; font-size: 1.1rem; color: #e2e8f0; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px; margin-top: 24px; }
        .stat-card { 
            background: rgba(255, 255, 255, 0.06); 
            padding: 20px; 
            border-radius: 12px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .stat-card:hover { background: rgba(255, 255, 255, 0.1); transform: translateY(-2px); }
        .stat-number { font-size: 2.2rem; font-weight: bold; margin-bottom: 8px; color: #ffffff; }
        .stat-label { opacity: 0.8; font-size: 0.95rem; color: #cbd5e0; }
        .tabs { 
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 16px; 
            overflow: hidden; 
            margin-bottom: 24px; 
            border: 1px solid rgba(255, 255, 255, 0.12); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .tab-buttons { display: flex; background: rgba(255, 255, 255, 0.04); border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
        .tab-button { 
            flex: 1; 
            padding: 18px; 
            background: none; 
            border: none; 
            color: #e2e8f0; 
            cursor: pointer; 
            font-size: 1rem; 
            font-weight: 500; 
            transition: all 0.3s ease; 
        }
        .tab-button.active { 
            background: rgba(66, 153, 225, 0.2); 
            border-bottom: 3px solid #4299e1; 
            color: #ffffff; 
        }
        .tab-button:hover { background: rgba(255, 255, 255, 0.08); }
        .tab-content { padding: 28px; }
        .trade-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .trade-card {
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }
        
        /* Macro Sentiment Panel Styles - Professional Dashboard Design */
        .macro-sentiment-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .macro-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        .macro-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #ffffff;
        }
        .macro-status-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        .macro-status-active { background: #38a169; color: white; }
        .macro-status-error { background: #e53e3e; color: white; }
        .macro-status-unknown { background: #718096; color: white; }
        .macro-metrics {
            display: grid;
            grid-template-columns: 200px repeat(3, 1fr) 200px;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Confidence Gauge Styles */
        .confidence-gauge {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }
        .gauge-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 12px;
        }
        .gauge-bg {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(from 0deg, #4ade80 0deg, #4ade80 var(--confidence-angle), rgba(255,255,255,0.1) var(--confidence-angle), rgba(255,255,255,0.1) 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .gauge-inner {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: rgba(26, 32, 44, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .gauge-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffffff;
            line-height: 1;
        }
        .gauge-max {
            font-size: 0.7rem;
            color: #a0aec0;
            margin-top: 2px;
        }
        .gauge-label {
            font-size: 0.85rem;
            color: #e2e8f0;
            text-align: center;
        }
        .gauge-status {
            font-size: 0.75rem;
            font-weight: bold;
            color: #4ade80;
            margin-top: 4px;
        }
        
        /* Trend Indicator Styles */
        .trend-indicator {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }
        .trend-indicator:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        .trend-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        .trend-icon {
            font-size: 1.2rem;
        }
        .trend-direction {
            font-size: 1.1rem;
            font-weight: bold;
            color: #4ade80;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .trend-strength-container {
            width: 100%;
            margin-top: 8px;
        }
        .trend-strength-label {
            font-size: 0.75rem;
            color: #a0aec0;
            margin-bottom: 4px;
        }
        .trend-strength-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }
        .trend-strength-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ade80, #22c55e);
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        .trend-strength-text {
            font-size: 0.8rem;
            color: #e2e8f0;
            margin-top: 4px;
            text-align: center;
        }
        .trend-label {
            font-size: 0.85rem;
            color: #cbd5e0;
            text-align: center;
        }
        
        /* Trade Permission Styles */
        .trade-permission {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .permission-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #22c55e;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 12px;
            font-size: 1.5rem;
            color: white;
        }
        .permission-status {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffffff;
            margin-bottom: 4px;
        }
        .permission-label {
            font-size: 0.85rem;
            color: #a0aec0;
            text-align: center;
        }
        
        .macro-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.9rem;
        }
        .macro-regime {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #e2e8f0;
        }
        .macro-regime-badge {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: bold;
            border: 1px solid;
        }
        .regime-alt_season { background: rgba(128, 0, 128, 0.2); color: #e879f9; border-color: #e879f9; }
        .regime-btc_season { background: rgba(255, 165, 0, 0.2); color: #ffb84d; border-color: #ffb84d; }
        .regime-transition { background: rgba(66, 153, 225, 0.2); color: #63b3ed; border-color: #63b3ed; }
        .regime-bear { background: rgba(229, 62, 62, 0.2); color: #fc8181; border-color: #fc8181; }
        .macro-last-updated {
            opacity: 0.8;
            color: #a0aec0;
            font-size: 0.85rem;
        }
        .macro-detail-btn {
            background: rgba(66, 153, 225, 0.2);
            border: 1px solid #4299e1;
            color: #4299e1;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .macro-detail-btn:hover {
            background: rgba(66, 153, 225, 0.3);
            transform: translateY(-1px);
        }
        .macro-loading {
            text-align: center;
            padding: 40px;
            color: #e2e8f0;
        }
        .macro-error {
            background: rgba(229, 62, 62, 0.15);
            border: 1px solid rgba(229, 62, 62, 0.3);
            padding: 16px;
            border-radius: 8px;
            color: #fc8181;
            text-align: center;
        }
        .trade-card:hover { 
            background: rgba(255, 255, 255, 0.1); 
            transform: translateY(-4px); 
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(66, 153, 225, 0.3);
        }
        .trade-card::after {
            content: '👁️ Click for details';
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 0.75rem;
            opacity: 0;
            color: #4299e1;
            transition: opacity 0.3s ease;
        }
        .trade-card:hover::after { opacity: 1; }
        .trade-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .trade-ticker { font-size: 1.3rem; font-weight: bold; color: #ffffff; }
        .trade-timeframe { opacity: 0.8; font-size: 0.9rem; color: #cbd5e0; }
        .trade-action { padding: 6px 12px; border-radius: 6px; font-size: 0.8rem; font-weight: bold; }
        .trade-action.buy { background: #38a169; color: white; box-shadow: 0 2px 8px rgba(56, 161, 105, 0.3); }
        .trade-action.sell { background: #e53e3e; color: white; box-shadow: 0 2px 8px rgba(229, 62, 62, 0.3); }
        .trade-details { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.9rem; margin-bottom: 16px; }
        .trade-detail { display: flex; justify-content: space-between; }
        .trade-detail-label { opacity: 0.8; color: #a0aec0; }
        .trade-detail-value { font-weight: 600; color: #ffffff; }
        .trade-pnl { padding: 12px; border-radius: 8px; text-align: center; font-weight: bold; margin-bottom: 12px; }
        .trade-pnl.profit { background: rgba(56, 161, 105, 0.2); color: #68d391; border: 1px solid rgba(56, 161, 105, 0.3); }
        .trade-pnl.loss { background: rgba(229, 62, 62, 0.2); color: #fc8181; border: 1px solid rgba(229, 62, 62, 0.3); }
        .empty-state { text-align: center; padding: 60px; opacity: 0.8; }
        .empty-icon { font-size: 4rem; margin-bottom: 20px; }
        .loading { text-align: center; padding: 60px; font-size: 1.2rem; color: #e2e8f0; }
        .error { 
            background: rgba(229, 62, 62, 0.15); 
            border: 1px solid rgba(229, 62, 62, 0.3); 
            padding: 20px; 
            border-radius: 12px; 
            margin-bottom: 24px; 
            color: #fc8181;
        }
        
        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(5px);
        }
        .modal-content { 
            background: linear-gradient(135deg, #2d3748 0%, #4a5568 100%); 
            margin: 5% auto; 
            padding: 0; 
            border-radius: 16px; 
            width: 90%; 
            max-width: 800px; 
            max-height: 85vh; 
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        .modal-header { 
            padding: 24px 32px; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
        }
        .modal-title { font-size: 1.5rem; font-weight: bold; color: #ffffff; }
        .close { 
            color: #a0aec0; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: color 0.3s ease;
        }
        .close:hover { color: #ffffff; }
        .modal-body { padding: 32px; }
        .recommendation-section { margin-bottom: 24px; }
        .recommendation-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 12px; color: #ffffff; }
        .recommendation-content { 
            background: rgba(255, 255, 255, 0.06); 
            padding: 16px; 
            border-radius: 8px; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            line-height: 1.6;
        }
        .price-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 20px; }
        .price-item { text-align: center; }
        .price-label { font-size: 0.9rem; opacity: 0.8; margin-bottom: 4px; color: #a0aec0; }
        .price-value { font-size: 1.1rem; font-weight: bold; color: #ffffff; }
        
        @media (max-width: 768px) { 
            .container { padding: 16px; } 
            .title { font-size: 2rem; } 
            .trade-grid { grid-template-columns: 1fr; } 
            .modal-content { width: 95%; margin: 10% auto; }
            .modal-body { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Macro Sentiment Panel -->
        <div class="macro-sentiment-panel" id="macro-sentiment-panel">
            <div id="macro-loading" class="macro-loading">
                Loading market macro sentiment...
            </div>
            <div id="macro-error" class="macro-error" style="display: none;">
                Failed to load macro sentiment data
            </div>
            <div id="macro-content" style="display: none;">
                <div class="macro-header">
                    <div class="macro-title">
                        📈 Market Macro Sentiment
                        <span class="macro-status-badge" id="macro-status">UNKNOWN</span>
                    </div>
                    <div class="macro-last-updated" id="macro-last-updated">
                        Last updated: --
                    </div>
                </div>
                
                <div class="macro-metrics">
                    <!-- Confidence Gauge -->
                    <div class="confidence-gauge">
                        <div class="gauge-container">
                            <div class="gauge-bg" id="confidence-gauge-bg">
                                <div class="gauge-inner">
                                    <div class="gauge-value" id="macro-confidence">--</div>
                                    <div class="gauge-max">/100</div>
                                </div>
                            </div>
                        </div>
                        <div class="gauge-label">Overall Confidence</div>
                        <div class="gauge-status" id="confidence-status">HIGH</div>
                    </div>
                    
                    <!-- BTC Trend -->
                    <div class="trend-indicator">
                        <div class="trend-header">
                            <span class="trend-icon">₿</span>
                            <div class="trend-label">BTC Trend</div>
                        </div>
                        <div class="trend-direction" id="btc-trend-direction">
                            <span>↗</span> UP
                        </div>
                        <div class="trend-strength-container">
                            <div class="trend-strength-label">Strength</div>
                            <div class="trend-strength-bar">
                                <div class="trend-strength-fill" id="btc-strength-fill"></div>
                            </div>
                            <div class="trend-strength-text" id="btc-strength-text">--</div>
                        </div>
                    </div>
                    
                    <!-- ETH Trend -->
                    <div class="trend-indicator">
                        <div class="trend-header">
                            <span class="trend-icon">Ξ</span>
                            <div class="trend-label">ETH Trend</div>
                        </div>
                        <div class="trend-direction" id="eth-trend-direction">
                            <span>↗</span> UP
                        </div>
                        <div class="trend-strength-container">
                            <div class="trend-strength-label">Strength</div>
                            <div class="trend-strength-bar">
                                <div class="trend-strength-fill" id="eth-strength-fill"></div>
                            </div>
                            <div class="trend-strength-text" id="eth-strength-text">--</div>
                        </div>
                    </div>
                    
                    <!-- ALT Trend -->
                    <div class="trend-indicator">
                        <div class="trend-header">
                            <span class="trend-icon">🔄</span>
                            <div class="trend-label">ALT Trend</div>
                        </div>
                        <div class="trend-direction" id="alt-trend-direction">
                            <span>↗</span> UP
                        </div>
                        <div class="trend-strength-container">
                            <div class="trend-strength-label">Strength</div>
                            <div class="trend-strength-bar">
                                <div class="trend-strength-fill" id="alt-strength-fill"></div>
                            </div>
                            <div class="trend-strength-text" id="alt-strength-text">--</div>
                        </div>
                    </div>
                    
                    <!-- Trade Permission -->
                    <div class="trade-permission">
                        <div class="permission-icon" id="permission-icon">▶</div>
                        <div class="permission-status" id="macro-trade-permission">Active</div>
                        <div class="permission-label">Active Trading</div>
                    </div>
                </div>
                
                <div class="macro-footer">
                    <div class="macro-regime">
                        <span>Market Regime:</span>
                        <span class="macro-regime-badge" id="macro-regime">UNKNOWN</span>
                    </div>
                    <button class="macro-detail-btn" onclick="showMacroDetails()">
                        📊 More Information
                    </button>
                </div>
            </div>
        </div>

        <div class="header">
            <h1 class="title">🤖 AI Trade Viewer Portal</h1>
            <p class="subtitle">Real-time view of AI-generated trade recommendations</p>
            <div class="stats">
                <div class="stat-card"><div class="stat-number" id="active-count">0</div><div class="stat-label">Active Trades</div></div>
                <div class="stat-card"><div class="stat-number" id="total-count">0</div><div class="stat-label">Total Trades</div></div>
                <div class="stat-card"><div class="stat-number" id="win-rate">0%</div><div class="stat-label">Win Rate</div></div>
                <div class="stat-card"><div class="stat-number" id="total-return">0%</div><div class="stat-label">Total Return</div></div>
            </div>
        </div>
        <div class="error" id="error-message" style="display: none;">Failed to load trade data. Make sure your backend is running on port 5000</div>
        <div class="tabs">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="0">Active Trades</button>
                <button class="tab-button" data-tab="1">Trade History</button>
                <button class="tab-button" data-tab="2">Performance</button>
            </div>
            <div class="tab-content">
                <div id="loading" class="loading">Loading AI trade data...</div>
                <div id="active-trades" style="display: none;"></div>
                <div id="trade-history" style="display: none;"></div>
                <div id="performance" style="display: none;"></div>
            </div>
        </div>
    </div>

    <!-- Modal for Trade Details -->
    <div id="tradeModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Trade Details</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let activeTrades = [];
        let tradeHistory = [];
        let currentTab = 0;
        let macroSentimentData = null;
        let allTrades = {}; // Store all trades by ID for modal access

        // Modal functionality
        const modal = document.getElementById('tradeModal');
        const closeBtn = document.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Macro Sentiment Functions
        async function loadMacroSentiment() {
            try {
                console.log('🔗 Loading macro sentiment data via ngrok tunnel...');
                
                // Use the same relative URL pattern as active trades to go through ngrok
                const response = await fetch('/api/macro-sentiment/status');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load macro sentiment');
                }
                
                macroSentimentData = result.data.sentiment;
                renderMacroSentiment(result.data);
                
                console.log('✅ Successfully loaded macro sentiment data');
                
            } catch (error) {
                console.error('Error loading macro sentiment:', error);
                document.getElementById('macro-loading').style.display = 'none';
                document.getElementById('macro-error').style.display = 'block';
                document.getElementById('macro-error').textContent = `Failed to load macro sentiment: ${error.message}`;
            }
        }

        function renderMacroSentiment(data) {
            const { sentiment, systemStatus } = data;
            
            if (!sentiment) {
                document.getElementById('macro-loading').style.display = 'none';
                document.getElementById('macro-error').style.display = 'block';
                document.getElementById('macro-error').textContent = 'No macro sentiment data available';
                return;
            }

            // Hide loading, show content
            document.getElementById('macro-loading').style.display = 'none';
            document.getElementById('macro-content').style.display = 'block';

            // Update status badge
            const statusElement = document.getElementById('macro-status');
            const status = systemStatus?.scanner?.system_status || 'UNKNOWN';
            statusElement.textContent = status;
            statusElement.className = `macro-status-badge macro-status-${status.toLowerCase()}`;

            // Update last updated with proper formatting
            const lastUpdated = new Date(sentiment.analysis_timestamp * 1000);
            document.getElementById('macro-last-updated').textContent =
                `Last updated: ${formatTimeAgo(lastUpdated.getTime())}`;

            // Update confidence gauge with proper percentage formatting
            // Note: overall_confidence is already stored as INTEGER 0-100 in database
            const confidence = sentiment.overall_confidence;
            document.getElementById('macro-confidence').textContent = confidence;
            
            // Update confidence gauge visual
            const gaugeElement = document.getElementById('confidence-gauge-bg');
            const angle = (confidence / 100) * 360;
            gaugeElement.style.setProperty('--confidence-angle', `${angle}deg`);
            
            // Update confidence status
            const confidenceStatus = document.getElementById('confidence-status');
            if (confidence >= 70) {
                confidenceStatus.textContent = 'HIGH';
                confidenceStatus.style.color = '#4ade80';
            } else if (confidence >= 50) {
                confidenceStatus.textContent = 'MEDIUM';
                confidenceStatus.style.color = '#fbbf24';
            } else {
                confidenceStatus.textContent = 'LOW';
                confidenceStatus.style.color = '#f87171';
            }

            // Update BTC trend
            updateTrendIndicator('btc', sentiment.btc_trend_direction, sentiment.btc_trend_strength);
            
            // Update ETH trend
            updateTrendIndicator('eth', sentiment.eth_trend_direction, sentiment.eth_trend_strength);
            
            // Update ALT trend
            updateTrendIndicator('alt', sentiment.alt_trend_direction, sentiment.alt_trend_strength);
            
            // Update trade permission
            const permissionElement = document.getElementById('macro-trade-permission');
            const permissionIcon = document.getElementById('permission-icon');
            
            if (sentiment.trade_permission === 'ACTIVE') {
                permissionElement.textContent = 'Active';
                permissionIcon.textContent = '▶';
                permissionIcon.style.background = '#22c55e';
            } else if (sentiment.trade_permission === 'CAUTION') {
                permissionElement.textContent = 'Caution';
                permissionIcon.textContent = '⚠';
                permissionIcon.style.background = '#f59e0b';
            } else {
                permissionElement.textContent = 'Inactive';
                permissionIcon.textContent = '⏸';
                permissionIcon.style.background = '#ef4444';
            }

            // Update market regime
            const regimeElement = document.getElementById('macro-regime');
            const regime = sentiment.market_regime.replace('_', ' ');
            regimeElement.textContent = regime;
            regimeElement.className = `macro-regime-badge regime-${sentiment.market_regime.toLowerCase()}`;
            
            // Store current data for modal use
            window.currentMacroData = data;
        }

        function updateTrendIndicator(type, direction, strength) {
            const directionElement = document.getElementById(`${type}-trend-direction`);
            const strengthFill = document.getElementById(`${type}-strength-fill`);
            const strengthText = document.getElementById(`${type}-strength-text`);
            
            // Update direction with proper arrow
            const arrow = direction === 'UP' ? '↗' : direction === 'DOWN' ? '↘' : '→';
            const color = direction === 'UP' ? '#4ade80' : direction === 'DOWN' ? '#f87171' : '#fbbf24';
            
            directionElement.innerHTML = `<span>${arrow}</span> ${direction}`;
            directionElement.style.color = color;
            
            // Update strength bar
            const strengthPercent = Math.min(100, Math.max(0, strength));
            strengthFill.style.width = `${strengthPercent}%`;
            strengthText.textContent = `${strengthPercent}%`;
            
            // Update strength bar color based on direction
            strengthFill.style.background = direction === 'UP' ?
                'linear-gradient(90deg, #4ade80, #22c55e)' :
                direction === 'DOWN' ?
                'linear-gradient(90deg, #f87171, #ef4444)' :
                'linear-gradient(90deg, #fbbf24, #f59e0b)';
        }

        function showMacroDetails() {
            if (!macroSentimentData) {
                alert('No macro sentiment data available');
                return;
            }

            const modal = document.getElementById('tradeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = 'Market Macro Sentiment Analysis';

            modalBody.innerHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-title">📊 Overall Market Assessment</div>
                    <div class="recommendation-content">
                        <strong>Overall Confidence:</strong> ${macroSentimentData.overall_confidence}%<br>
                        <strong>Market Regime:</strong> ${macroSentimentData.market_regime.replace('_', ' ')}<br>
                        <strong>Trade Permission:</strong> ${macroSentimentData.trade_permission}<br>
                        <strong>Last Updated:</strong> ${new Date(macroSentimentData.analysis_timestamp * 1000).toLocaleString()}
                    </div>
                </div>

                <div class="recommendation-section">
                    <div class="recommendation-title">₿ Bitcoin Trend Analysis</div>
                    <div class="recommendation-content">
                        <strong>Direction:</strong> ${macroSentimentData.btc_trend_direction}<br>
                        <strong>Strength:</strong> ${macroSentimentData.btc_trend_strength}<br>
                        <strong>Confidence:</strong> N/A
                    </div>
                </div>

                <div class="recommendation-section">
                    <div class="recommendation-title">Ξ Ethereum Trend Analysis</div>
                    <div class="recommendation-content">
                        <strong>Direction:</strong> ${macroSentimentData.eth_trend_direction}<br>
                        <strong>Strength:</strong> ${macroSentimentData.eth_trend_strength}<br>
                        <strong>Confidence:</strong> N/A
                    </div>
                </div>

                <div class="recommendation-section">
                    <div class="recommendation-title">🔄 Altcoin Trend Analysis</div>
                    <div class="recommendation-content">
                        <strong>Direction:</strong> ${macroSentimentData.alt_trend_direction}<br>
                        <strong>Strength:</strong> ${macroSentimentData.alt_trend_strength}<br>
                        <strong>Confidence:</strong> N/A
                    </div>
                </div>

                ${macroSentimentData.ai_reasoning ? `
                <div class="recommendation-section">
                    <div class="recommendation-title">🧠 AI Analysis Summary</div>
                    <div class="recommendation-content">
                        ${macroSentimentData.ai_reasoning}
                    </div>
                </div>
                ` : `
                <div class="recommendation-section">
                    <div class="recommendation-title">🧠 AI Analysis Summary</div>
                    <div class="recommendation-content">
                        <em>AI analysis summary not available for this data point.</em>
                    </div>
                </div>
                `}
            `;

            modal.style.display = 'block';
        }

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                const tabIndex = parseInt(button.dataset.tab);
                switchTab(tabIndex);
            });
        });

        function switchTab(tabIndex) {
            currentTab = tabIndex;
            document.querySelectorAll('.tab-button').forEach((btn, index) => {
                btn.classList.toggle('active', index === tabIndex);
            });
            document.getElementById('loading').style.display = 'none';
            document.getElementById('active-trades').style.display = tabIndex === 0 ? 'block' : 'none';
            document.getElementById('trade-history').style.display = tabIndex === 1 ? 'block' : 'none';
            document.getElementById('performance').style.display = tabIndex === 2 ? 'block' : 'none';
            if (tabIndex === 0) renderActiveTrades();
            else if (tabIndex === 1) renderTradeHistory();
            else renderPerformance();
        }

        // Data loading - Uses relative URLs that go through ngrok
        async function loadData() {
            try {
                document.getElementById('error-message').style.display = 'none';

                console.log('🔗 Connecting to backend via ngrok tunnel...');

                // Load both trade data and macro sentiment in parallel
                const [activeResponse, historyResponse] = await Promise.all([
                    fetch('/api/active-trades/all'),
                    fetch('/api/active-trades/history-all')
                ]);

                if (!activeResponse.ok || !historyResponse.ok) {
                    throw new Error(`HTTP ${activeResponse.status} - ${historyResponse.status}`);
                }

                const activeData = await activeResponse.json();
                const historyData = await historyResponse.json();

                activeTrades = (activeData.active_trades || []).map(convertTrade);
                tradeHistory = (historyData.all_trades || []).map(convertTrade);
                
                // Store all trades in global object for modal access
                [...activeTrades, ...tradeHistory].forEach(trade => {
                    allTrades[trade.id] = trade;
                });

                updateStats();
                switchTab(currentTab);

                console.log(`✅ Successfully loaded ${activeTrades.length} active trades and ${tradeHistory.length} historical trades`);

                // Load macro sentiment data (non-blocking)
                loadMacroSentiment();

            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('error-message').style.display = 'block';
                document.getElementById('error-message').textContent = `Failed to load trade data. Error: ${error.message}`;
                document.getElementById('loading').textContent = 'Failed to load data - check console for details';
            }
        }

        function convertTrade(trade) {
            const entryTime = new Date(trade.created_at).getTime();
            const currentTime = Date.now();
            let profitLossPercentage = 0;

            if (trade.status === 'profit_hit' || trade.status === 'stop_hit') {
                if (trade.entry_price && trade.close_price) {
                    if (trade.action === 'buy') {
                        profitLossPercentage = ((trade.close_price - trade.entry_price) / trade.entry_price) * 100;
                    } else {
                        profitLossPercentage = ((trade.entry_price - trade.close_price) / trade.entry_price) * 100;
                    }
                }
            }

            return {
                id: `backend-${trade.id}-${trade.ticker}-${trade.timeframe}`,
                ticker: trade.ticker,
                timeframe: trade.timeframe,
                action: trade.action,
                entryPrice: trade.entry_price,
                targetPrice: trade.target_price,
                stopLoss: trade.stop_loss,
                status: trade.status,
                confidence: 1.0,
                aiModel: 'production_system',
                reasoning: trade.reasoning || `Production ${trade.action.toUpperCase()} trade from Chart Analysis`,
                entryDate: entryTime,
                profitLossPercentage: profitLossPercentage,
                timeSinceRecommendation: currentTime - entryTime,
                rawTrade: trade // Keep original trade data for modal
            };
        }

        function showTradeModal(trade) {
            const modal = document.getElementById('tradeModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            modalTitle.textContent = `${trade.ticker} ${trade.timeframe} - ${trade.action.toUpperCase()} Trade`;

            const riskReward = trade.targetPrice && trade.stopLoss && trade.entryPrice ?
                (Math.abs(trade.targetPrice - trade.entryPrice) / Math.abs(trade.entryPrice - trade.stopLoss)).toFixed(2) : 'N/A';

            modalBody.innerHTML = `
                <div class="recommendation-section">
                    <div class="recommendation-title">🎯 Trading Recommendations</div>
                    <div style="background: rgba(66, 153, 225, 0.15); border: 1px solid rgba(66, 153, 225, 0.4); border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2rem; font-weight: bold; color: #ffffff;">${trade.ticker}</span>
                                <span style="background: ${trade.action === 'buy' ? '#38a169' : '#e53e3e'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold;">${trade.action.toUpperCase()}</span>
                                <span style="background: rgba(255, 255, 255, 0.15); color: #e2e8f0; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem;">${trade.timeframe}</span>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.8rem; opacity: 0.9; color: #cbd5e0;">Risk/Reward</div>
                                <div style="font-size: 1.1rem; font-weight: bold; color: #63b3ed;">1:${riskReward}</div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 16px;">
                            <div style="font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; color: #f7fafc;">Summary</div>
                            <div style="font-size: 0.9rem; line-height: 1.5; color: #e2e8f0;">
                                ${trade.action.toUpperCase()} at $${trade.entryPrice.toFixed(2)} | Target: $${trade.targetPrice ? trade.targetPrice.toFixed(2) : 'N/A'} | Stop: $${trade.stopLoss ? trade.stopLoss.toFixed(2) : 'N/A'} | R/R: 1:${riskReward}
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px;">
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; color: #cbd5e0;">Entry Price</div>
                                <div style="font-size: 1rem; font-weight: bold; color: #ffffff;">$${trade.entryPrice.toFixed(2)}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; color: #cbd5e0;">Target Price</div>
                                <div style="font-size: 1rem; font-weight: bold; color: #68d391;">$${trade.targetPrice ? trade.targetPrice.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; color: #cbd5e0;">Stop Loss</div>
                                <div style="font-size: 1rem; font-weight: bold; color: #fc8181;">$${trade.stopLoss ? trade.stopLoss.toFixed(2) : 'N/A'}</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 4px; color: #cbd5e0;">Current Price</div>
                                <div style="font-size: 1rem; font-weight: bold; color: #ffffff;">$${trade.rawTrade.current_price ? trade.rawTrade.current_price.toFixed(2) : 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="recommendation-section">
                    <div class="recommendation-title">🤖 AI Analysis</div>
                    <div class="recommendation-content">
                        <strong>Model:</strong> ${trade.aiModel}<br>
                        <strong>Confidence:</strong> ${(trade.confidence * 100).toFixed(1)}%<br>
                        <strong>Status:</strong> ${trade.status}<br>
                        <strong>Created:</strong> ${new Date(trade.entryDate).toLocaleString()}<br>
                        <strong>Time Active:</strong> ${formatTimeAgo(trade.timeSinceRecommendation)}
                    </div>
                </div>

                <div class="recommendation-section">
                    <div class="recommendation-title">💡 AI Reasoning</div>
                    <div class="recommendation-content">
                        ${trade.reasoning || `Production ${trade.action.toUpperCase()} trade from Chart Analysis. ${trade.ticker} has formed a ${trade.action === 'buy' ? 'bullish' : 'bearish'} pattern around $${trade.entryPrice.toFixed(2)} and has broken ${trade.action === 'buy' ? 'above' : 'below'} key resistance. Current price at $${trade.rawTrade.current_price ? trade.rawTrade.current_price.toFixed(2) : trade.entryPrice.toFixed(2)} shows ${trade.action === 'buy' ? 'upward' : 'downward'} momentum. Strategy includes ${trade.targetPrice ? `high probability target at $${trade.targetPrice.toFixed(2)}` : 'momentum-based exit'} with ${trade.stopLoss ? `protective stop at $${trade.stopLoss.toFixed(2)}` : 'risk management protocols'}.`}
                    </div>
                </div>

                ${trade.profitLossPercentage !== undefined ? `
                <div class="recommendation-section">
                    <div class="recommendation-title">📈 Performance</div>
                    <div class="recommendation-content">
                        <strong>P&L:</strong> <span style="color: ${trade.profitLossPercentage >= 0 ? '#68d391' : '#fc8181'}">
                            ${trade.profitLossPercentage >= 0 ? '+' : ''}${trade.profitLossPercentage.toFixed(2)}%
                        </span><br>
                        ${trade.rawTrade.realized_pnl ? `<strong>Realized P&L:</strong> $${trade.rawTrade.realized_pnl.toFixed(2)}<br>` : ''}
                        ${trade.rawTrade.unrealized_pnl ? `<strong>Unrealized P&L:</strong> $${trade.rawTrade.unrealized_pnl.toFixed(2)}` : ''}
                    </div>
                </div>
                ` : ''}
            `;

            modal.style.display = 'block';
        }

        function updateStats() {
            const totalTrades = tradeHistory.length;
            const profitableTrades = tradeHistory.filter(t => t.profitLossPercentage > 0).length;
            const winRate = totalTrades > 0 ? (profitableTrades / totalTrades) * 100 : 0;
            const totalReturn = tradeHistory.reduce((sum, t) => sum + t.profitLossPercentage, 0);

            document.getElementById('active-count').textContent = activeTrades.length;
            document.getElementById('total-count').textContent = totalTrades;
            document.getElementById('win-rate').textContent = winRate.toFixed(1) + '%';
            document.getElementById('total-return').textContent = totalReturn.toFixed(2) + '%';
        }

        function renderActiveTrades() {
            const container = document.getElementById('active-trades');
            if (activeTrades.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📊</div><div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">No Active Trades</div><div>AI trade recommendations will appear here when generated.</div></div>';
                return;
            }
            container.innerHTML = `<div class="trade-grid">${activeTrades.map(trade => renderTradeCard(trade, true)).join('')}</div>`;
        }

        function renderTradeHistory() {
            const container = document.getElementById('trade-history');
            if (tradeHistory.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">📈</div><div style="font-size: 1.2rem; font-weight: bold; margin-bottom: 8px;">No Trade History</div><div>Historical trade data will appear here as trades are completed.</div></div>';
                return;
            }
            container.innerHTML = `<div class="trade-grid">${tradeHistory.map(trade => renderTradeCard(trade, false)).join('')}</div>`;
        }

        function renderPerformance() {
            const container = document.getElementById('performance');
            const totalTrades = tradeHistory.length;
            const profitableTrades = tradeHistory.filter(t => t.profitLossPercentage > 0).length;
            const winRate = totalTrades > 0 ? (profitableTrades / totalTrades) * 100 : 0;
            const totalReturn = tradeHistory.reduce((sum, t) => sum + t.profitLossPercentage, 0);

            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 24px;">
                    <div class="stat-card"><div class="stat-number">${totalTrades}</div><div class="stat-label">Total Trades</div></div>
                    <div class="stat-card"><div class="stat-number">${winRate.toFixed(1)}%</div><div class="stat-label">Win Rate</div></div>
                    <div class="stat-card"><div class="stat-number">${totalReturn.toFixed(2)}%</div><div class="stat-label">Total Return</div></div>
                    <div class="stat-card"><div class="stat-number">${activeTrades.length}</div><div class="stat-label">Active Trades</div></div>
                </div>
            `;
        }

        function showTradeById(tradeId) {
            const trade = allTrades[tradeId];
            if (trade) {
                showTradeModal(trade);
            } else {
                console.error('Trade not found:', tradeId);
            }
        }

        function renderTradeCard(trade, isActive) {
            const isBuy = trade.action === 'buy';
            const timeAgo = formatTimeAgo(trade.timeSinceRecommendation);

            return `
                <div class="trade-card" onclick="showTradeById('${trade.id}')">
                    <div class="trade-header">
                        <div><div class="trade-ticker">${trade.ticker}</div><div class="trade-timeframe">${trade.timeframe}</div></div>
                        <div class="trade-action ${isBuy ? 'buy' : 'sell'}">${trade.action.toUpperCase()}</div>
                    </div>
                    <div class="trade-details">
                        <div class="trade-detail"><span class="trade-detail-label">Entry Price</span><span class="trade-detail-value">$${trade.entryPrice.toFixed(2)}</span></div>
                        ${trade.targetPrice ? `<div class="trade-detail"><span class="trade-detail-label">Target</span><span class="trade-detail-value" style="color: #68d391;">$${trade.targetPrice.toFixed(2)}</span></div>` : ''}
                        ${trade.stopLoss ? `<div class="trade-detail"><span class="trade-detail-label">Stop Loss</span><span class="trade-detail-value" style="color: #fc8181;">$${trade.stopLoss.toFixed(2)}</span></div>` : ''}
                        <div class="trade-detail"><span class="trade-detail-label">Confidence</span><span class="trade-detail-value" style="color: #4299e1;">${(trade.confidence * 100).toFixed(0)}%</span></div>
                    </div>
                    ${trade.profitLossPercentage !== undefined ? `<div class="trade-pnl ${trade.profitLossPercentage >= 0 ? 'profit' : 'loss'}">P&L: ${trade.profitLossPercentage >= 0 ? '+' : ''}${trade.profitLossPercentage.toFixed(2)}%</div>` : ''}
                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 12px; color: #a0aec0;">${timeAgo} • ${trade.aiModel}</div>
                    <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 6px; line-height: 1.4; color: #cbd5e0;">${trade.reasoning.length > 80 ? trade.reasoning.substring(0, 80) + '...' : trade.reasoning}</div>
                </div>
            `;
        }

        function formatTimeAgo(milliseconds) {
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            if (days > 0) return `${days}d ago`;
            if (hours > 0) return `${hours}h ago`;
            if (minutes > 0) return `${minutes}m ago`;
            return `${seconds}s ago`;
        }

        // Auto-refresh every 30 seconds
        setInterval(loadData, 30000);

        // Initial load
        loadData();
    </script>
</body>
</html>